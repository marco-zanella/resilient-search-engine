<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Control Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
</head>
<body>
  <div id="app">
    <header-component></header-component>
    <navbar-component></navbar-component>

    <div class="container my-3">
      <!-- Operation Feedback -->
      <div v-if="operationStatus === 'success'" class="alert alert-success alert-dismissible fade show" role="alert">
        {{ operationMessage }}
        <button type="button" class="btn-close" @click="clearStatus()" aria-label="Close"></button>
      </div>

      <div v-if="operationStatus === 'error'" class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ operationMessage }}
        <button type="button" class="btn-close" @click="clearStatus()" aria-label="Close"></button>
      </div>

      <div v-if="loadingLanguage" class="alert alert-info" role="alert">
        Processing <strong>{{ loadingLanguage }}</strong>... Please wait.
      </div>

      <div class="row">
        <main class="col-7">
          <!-- Indices and datasets -->
          <h2>Indices and Datasets</h2>
          <div v-for="language in languages" class="card mb-4">
            <div class="card-body">
              <h3 class="card-title text-capitalize d-flex justify-content-between">
                {{ language }}
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" class="btn btn-outline-success" @click="createIndex(language)">Create</button>
                  <button type="button" class="btn btn-outline-danger" @click="reloadIndex(language)">Reload</button>
                  <button type="button" class="btn btn-outline-danger" @click="deleteIndex(language)">Delete</button>
                </div>
              </h3>
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="dataset in datasets[language]">
                    <td>{{ dataset }}</td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-success" @click="indexDataset(language, dataset)">Index</button>
                        <button type="button" class="btn btn-outline-secondary" @click="clearEmbeddingCache(language, dataset)">Clear Embedding Cache</button>
                        <button type="button" class="btn btn-outline-danger" @click="deleteDataset(language, dataset)">Delete</button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="card-footer d-flex justify-content-end">
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-success text-capitalize" @click="indexDatasetsByLanguage(language)">Index {{ language }}</button>
                <button type="button" class="btn btn-outline-danger text-capitalize" @click="deleteDatasetsByLanguage(language)">Delete {{ language }}</button>
              </div>
            </div>          
          </div>
        </main>

        <aside class="col-5">
          <h2>Log System</h2>
          <div class="card mb-4">
            <ul class="list-group list-group-flush overflow-y-scroll" style="height: 70vh;">
              <li v-for="line in logs" class="list-group-item">
                <div>
                  <span class="badge text-uppercase" :class="'text-bg-' + levelToColor(line.level)">{{ line.level }}</span>
                  {{ line.message }}
                </div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">{{ line.service }}</span>
                  <span class="text-muted">{{ line.timestamp }}</span>
                </div>
              </li>
            </ul>
            <div class="card-footer d-flex justify-content-end">
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" @click="fetchLogs()">Refresh</button>
                <button type="button" class="btn btn-outline-danger" @click="clearLogs()">Clear</button>
              </div>
            </div>         
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="/static/scripts/header.js"></script>
  <script src="/static/scripts/navbar.js"></script>
  <script>
    const { createApp } = Vue;
    var app = createApp({
      data() {
        return {
          languages: [],
          datasets: {},
          logs: [],
          loadingLanguage: null,
          operationStatus: null,
          operationMessage: '',
        }
      },

      methods: {
        async fetchLanguages() {
          const response = await fetch('/api/languages')
          const data = await response.json()
          this.languages = data
        },

        async fetchDatasets() {
          const response = await fetch('/api/data')
          const data = await response.json()
          this.datasets = data
        },
        
        async createIndex(language) {
          this.loadingLanguage = language
          this.operationStatus = null
          this.operationMessage = 'Creating index...'

          try {
            const response = await fetch(`/api/indices/${language}`, { method: 'POST' })
            const result = await response.json()

            if (!response.ok || !result.success) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = `Index for "${language}" created successfully!`
          } catch (err) {
            this.operationStatus = 'error';
            this.operationMessage = `Failed to create index for "${language}": ${err.message}`;
          } finally {
            this.loadingLanguage = null;
          }
        },

        async deleteIndex(language) {
          if (!confirm("Are you sure you want to delete this index? Every indexed content will be lost.")) return
          this.loadingLanguage = language
          this.operationStatus = null
          this.operationMessage = 'Deleting index...'

          try {
            const response = await fetch(`/api/indices/${language}`, { method: 'DELETE' })
            const result = await response.json()

            if (!response.ok || !result.success) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success';
            this.operationMessage = `Index for "${language}" deleted successfully.`
          } catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to delete index for "${language}": ${err.message}`
          } finally {
            this.loadingLanguage = null;
          }
        },
        
        async reloadIndex(language) {
          if (!confirm("Are you sure you want to reload this index? Every indexed content will be lost.")) return
          this.loadingLanguage = language
          this.operationStatus = null
          this.operationMessage = 'Reloading index...'

          try {
            const response = await fetch(`/api/indices/${language}/reload`, { method: 'POST' })
            const result = await response.json()

            if (!response.ok || !result.success) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = `Index for "${language}" reloaded successfully!`
          } catch (err) {
            this.operationStatus = 'error';
            this.operationMessage = `Failed to reload index for "${language}": ${err.message}`
          } finally {
            this.loadingLanguage = null
          }
        },

        async indexAllDatasets() {
          this.loadingLanguage = 'all languages'
          this.operationStatus = null
          this.operationMessage = 'Indexing every dataset...'

          try {
            const response = await fetch('/api/data', { method: 'POST' })
            const result = await response.json()

            if (!response.ok) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = 'Every dataset indexed successfully!'
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to index datasets: ${err.message}`
          }
          finally {
            this.loadingLanguage = null
          }
        },

        async deleteAllDatasets() {
          if (!confirm("Are you sure you want to delete every dataset from the index?")) return
          this.loadingLanguage = 'all languages'
          this.operationStatus = null
          this.operationMessage = 'Deleting every dataset...'

          try {
            const response = await fetch('/api/data', { method: 'DELETE' })
            const result = await response.json()

            if (!response.ok) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = 'Every dataset deleted successfully!'
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to delete datasets: ${err.message}`
          }
          finally {
            this.loadingLanguage = null
          }
        },

        async indexDatasetsByLanguage(language) {
          this.loadingLanguage = language
          this.operationStatus = null
          this.operationMessage = `Indexing every dataset for ${language}...`

          try {
            const response = await fetch(`/api/data/${language}`, { method: 'POST' })
            const result = await response.json()

            if (!response.ok) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = `Every dataset for ${language} indexed successfully!`
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to index datasets for ${language}: ${err.message}`
          }
          finally {
            this.loadingLanguage = null
          }
        },

        async deleteDatasetsByLanguage(language) {
          if (!confirm("Are you sure you want to delete every dataset for this language from the index?")) return
          this.loadingLanguage = language
          this.operationStatus = null
          this.operationMessage = `Deleting every dataset for ${language}...`

          try {
            const response = await fetch(`/api/data/${language}`, { method: 'DELETE' })
            const result = await response.json()

            if (!response.ok) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = `Every dataset for ${language} deleted successfully!`
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to delete datasets for ${language}: ${err.message}`
          }
          finally {
            this.loadingLanguage = null
          }
        },

        async indexDataset(language, dataset) {
          this.loadingLanguage = language
          this.operationStatus = null
          this.operationMessage = `Indexing dataset ${dataset} for ${language}...`

          try {
            const response = await fetch(`/api/data/${language}/${dataset}`, { method: 'POST' })
            const result = await response.json()

            if (!response.ok) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = `Dataset ${dataset} for ${language} indexed successfully!`
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to index dataset ${dataset} for ${language}: ${err.message}`
          }
          finally {
            this.loadingLanguage = null
          }
        },

        async deleteDataset(language, dataset) {
          if (!confirm("Are you sure you want to delete this dataset from the index?")) return
          this.loadingLanguage = language
          this.operationStatus = null
          this.operationMessage = `Deleting dataset ${dataset} for ${language}...`

          try {
            const response = await fetch(`/api/data/${language}/${dataset}`, { method: 'DELETE' })
            const result = await response.json()

            if (!response.ok) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = `Dataset ${dataset} for ${language} deleted successfully!`
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to delete dataset ${dataset} for ${language}: ${err.message}`
          }
          finally {
            this.loadingLanguage = null
          }
        },

        async clearEmbeddingCache(language, dataset) {
          if (!confirm("Are you sure you want to delete embedding cache?")) return
          this.loadingLanguage = language
          this.operationStatus = null
          this.operationMessage = `Clearing embedding cache for dataset ${dataset} for ${language}...`

          try {
            const response = await fetch(`/api/data/${language}/${dataset}/embedding`, { method: 'DELETE' })
            const result = await response.json()

            if (!response.ok) throw new Error(result.message || 'Unknown error')

            this.operationStatus = 'success'
            this.operationMessage = `Embedding cache for ${dataset} for ${language} deleted successfully!`
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to delete embedding cache for dataset ${dataset} for ${language}: ${err.message}`
          }
          finally {
            this.loadingLanguage = null
          }
        },

        async fetchLogs() {
          try {
            const response = await fetch('/api/logs')
            this.logs = await response.json()
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to retrieve logs: ${err.message}`
          }
        },

        async clearLogs() {
          if (!confirm("Are you sure you want to delete logs?")) return
          try {
            await fetch('/api/logs', { method: 'DELETE' })
            await this.fetchLogs()
          }
          catch (err) {
            this.operationStatus = 'error'
            this.operationMessage = `Failed to delete logs: ${err.message}`
          }
        },

        levelToColor(level) {
          switch (level?.toLowerCase()) {
            case 'info': return 'info'
            case 'warning': return 'warning'
            case 'error': return 'danger'
            default: return 'secondary'
          }
        },

        clearStatus() {
          this.operationStatus = null;
          this.operationMessage = '';
        },
      },

      created() {
        this.fetchLanguages()
        this.fetchDatasets()
        this.fetchLogs()
      },
    })
    app.component('navbar-component', NavbarComponent)
    app.component('header-component', HeaderComponent)
    app.mount('#app')
  </script>
</body>
</html>