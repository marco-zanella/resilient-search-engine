<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test Cases</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
</head>
<body>
  <div id="app">
    <header-component></header-component>
    <navbar-component></navbar-component>

    <main class="container my-3">
      <!-- Operation Feedback -->
      <div v-if="operationStatus === 'success'" class="alert alert-success alert-dismissible fade show" role="alert">
        {{ operationMessage }}
        <button type="button" class="btn-close" @click="clearStatus()" aria-label="Close"></button>
      </div>

      <div v-if="operationStatus === 'error'" class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ operationMessage }}
        <button type="button" class="btn-close" @click="clearStatus()" aria-label="Close"></button>
      </div>

      <div v-if="loadingLanguage" class="alert alert-info" role="alert">
        Processing <strong>{{ loadingLanguage }}</strong>... Please wait.
      </div>

      <div class="row">
        <!-- List of Test Cases -->
        <div class="col-8">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Test Cases</h5>
              <div class="card-body">
                <div class="row">
                  <label for="tagFilter" class="col-form-label col-2">Filter by Tag</label>
                  <div class="col-10">
                    <input type="text" class="form-control" id="tagFilter" v-model="tagFilter" @input="fetchTestCases" placeholder="e.g. genesis">
                  </div>
                </div>
              </div>
              <ul class="list-group">
                <li v-for="tc in test_cases" :key="tc.id" class="list-group-item d-flex justify-content-between align-items-start">
                  <div>
                    <strong>#{{ tc.id }}</strong>: {{ tc.content }}
                    <div class="text-muted"><small>{{ tc.source }} â€” {{ tc.language }}</small></div>
                  </div>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" @click="editTestCase(tc)">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" @click="deleteTestCase(tc.id)">Delete</button>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Create / Edit Form -->
        <div class="col-4">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title">{{ editingTestCase ? 'Edit Test Case' : 'New Test Case' }}</h5>
              <form @submit.prevent="submitTestCase">
                <div class="mb-2">
                  <label class="form-label">Source</label>
                  <input type="text" class="form-control" v-model="form.source">
                </div>
                <div class="mb-2">
                  <label class="form-label">Content</label>
                  <textarea class="form-control" v-model="form.content" required></textarea>
                </div>
                <div class="mb-2">
                  <label class="form-label">Context</label>
                  <textarea class="form-control" v-model="form.context"></textarea>
                </div>
                <div class="mb-2">
                  <label class="form-label">Language</label>
                  <input type="text" class="form-control" v-model="form.language" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">Target</label>
                  <input type="text" class="form-control" v-model="form.target" required>
                </div>
                <div class="mb-2">
                  <label class="form-label">Tags (comma-separated)</label>
                  <input type="text" class="form-control" v-model="form.tagsRaw">
                </div>
                <button type="submit" class="btn btn-success me-2">{{ editingTestCase ? 'Update' : 'Create' }}</button>
                <button type="button" class="btn btn-secondary" v-if="editingTestCase" @click="cancelEdit()">Cancel</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="/static/scripts/header.js"></script>
  <script src="/static/scripts/navbar.js"></script>
  <script>
    const { createApp } = Vue;
    var app = createApp({
      data() {
        return {
          test_cases: [],
          operationStatus: null,
          operationMessage: '',
          loadingLanguage: null,
          form: {
            source: '',
            content: '',
            context: '',
            language: '',
            target: '',
            tagsRaw: '',
          },
          editingTestCase: null,
          tagFilter: '',
        }
      },
      mounted() {
        this.fetchTestCases();
      },
      methods: {
        apiUrl(path) {
          return `/api/test-cases${path}`;
        },
        clearStatus() {
          this.operationStatus = null;
          this.operationMessage = '';
        },
        fetchTestCases() {
          let url = this.apiUrl('');
          if (this.tagFilter.trim() !== '') {
            url += `?tag=${encodeURIComponent(this.tagFilter.trim())}`;
          }

          fetch(url)
            .then(res => res.json())
            .then(data => this.test_cases = data);
        },
        submitTestCase() {
          const payload = {
            ...this.form,
            tags: this.form.tagsRaw.split(',').map(tag => tag.trim()).filter(tag => tag)
          };

          const method = this.editingTestCase ? 'PUT' : 'POST';
          const url = this.editingTestCase ? this.apiUrl(`/${this.editingTestCase.id}`) : this.apiUrl('/');

          fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(res => {
            if (!res.ok) throw new Error('Failed to save test case');
            return res.json();
          })
          .then(() => {
            this.setStatus('success', `Test case ${this.editingTestCase ? 'updated' : 'created'} successfully`);
            this.resetForm();
            this.fetchTestCases();
          })
          .catch(err => this.setStatus('error', err.message));
        },
        editTestCase(tc) {
          this.editingTestCase = tc;
          this.form = {
            source: tc.source,
            content: tc.content,
            context: tc.context,
            language: tc.language,
            target: tc.target,
            tagsRaw: tc.tags.join(', ')
          };
        },
        cancelEdit() {
          this.resetForm();
        },
        resetForm() {
          this.form = {
            source: '',
            content: '',
            context: '',
            language: '',
            target: '',
            tagsRaw: '',
          };
          this.editingTestCase = null;
        },
        deleteTestCase(id) {
          if (!confirm("Are you sure you want to delete this test case?")) return
          fetch(this.apiUrl(`/${id}`), { method: 'DELETE' })
            .then(res => {
              if (!res.ok) throw new Error("Delete failed");
              this.setStatus('success', 'Test case deleted');
              this.fetchTestCases();
            })
            .catch(err => this.setStatus('error', err.message));
        },
        setStatus(status, msg) {
          this.operationStatus = status;
          this.operationMessage = msg;
          setTimeout(() => this.clearStatus(), 10000);
        }
      }
    })
    app.component('navbar-component', NavbarComponent)
    app.component('header-component', HeaderComponent)
    app.mount('#app')
  </script>
</body>
</html>